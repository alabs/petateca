{% extends "base_stripped.html" %}
{% load thumbnail %}
{% block title %}{% if serie %}Editando serie {{ serie.name }}{% else %}Agregando serie nueva{% endif %} | Liberateca{% endblock %}
{% block contents %}
        {{ message }}
        <form id="add_serie_form" class="grid_3" action="{% if serie %}{% url edit_serie serie_slug=serie.slug_name %}{% else %}{% url add_serie %}{% endif %}" method="POST">
        <h2> Información </h2>
        {{ form.non_field_errors }}
        <div class="left">
            {% if serie.poster.src %}
                {% thumbnail serie.poster.src "400x300" as img_serie %}
                    <img id="poster" src="{{ img_serie.url }}" />
                {% endthumbnail %}
            {% else %}
                <div class="image_not_found">  <img src="/static/images/image_not_available.png" height="200"> </div>
            {% endif %}
            <input type="file" name="image" size="20">
        </div>
        <div class="right">
            <ul class="left">
                <li>
                    {{ form.name_es.errors }}
                    <label for="id_name_es">Nombre [es]:</label>
                    {{ form.name_es }}
                </li>
                <li class="fieldwrapper">
                    {{ form.name_en.errors }}
                    <label for="id_name_en">Nombre [en]:</label>
                    {{ form.name_en }}
                </li>
                <li class="fieldWrapper">
                    {{ form.network.errors }}
                    <label for="id_network">Cadena:</label>
                    {{ form.network }}
                </li>
                <li class="fieldwrapper">
                    {{ form.finished.errors }}
                    <label for="id_finished">Finalizada:</label>
                    {{ form.finished }}
                </li>
                <li class="fieldWrapper">
                    {{ form.runtime.errors }}
                    <label for="id_runtime">Duración (en minutos):</label>
                    {{ form.runtime }}
                </li>
                <li class="fieldWrapper">
                    {{ form.genres.errors }}
                    <label for="id_genres">Géneros:</label>
                    {{ form.genres }}
                </li>
            </ul>
        </div>
        <h2>Descripción</h2>
        <table>
            <tr>
                <th>
                    Español
                </th>
                <th>
                    Inglés
                </th>
            </tr>
            <tr>
                <td>
                    {{ form.description_es.errors }}
                    {{ form.description_es }}
                </td>
                <td>
                    {{ form.description_en.errors }}
                    {{ form.description_en }}
                </td>
            </tr>
        </table>
    </ul>
                <input class="button" id="submit_serie" type="submit" value="{% if serie %}Editar{% else %}Agregar{% endif %}" />
        </form>
        <script>
        $("select[multiple]").asmSelect({
            animate: true,
            addItemTarget: 'top'
        });

            
        $('#submit_serie').click(function (e) {
            e.preventDefault();
            
            var $name_es = $('input[name=name_es]');
            var $name_en = $('input[name=name_en]');
            var $description_es = $('textarea[name=description_es]');
            var $description_en = $('textarea[name=description_en]');
            var $network = $('select[name=network]');
            var $runtime = $('input[name=runtime]');
            var $finished = $('input[name=finished]');

            var post_url = $('form#add_serie_form[action]').attr('action');

            var genres_list = [];
            $("#asmSelect0 .asmOptionDisabled").each(function (i, selected) { 
                genres_list[i] = $(selected).val(); 
            });
            var genres = genres_list.join()

            // FIXME: Comprobamos que ningun campo este en blanco, lo suyo seria hacer esto pero no funcioan
        //    fields = [ $air_date, $title_es, $title_en, $episode ]
        //    $.each(fields, function(index, f){
        //        if (f.val()==='') {
        //            f.addClass('hightlight'); 
        //            return false;
        //        } else f.removeClass('hightlight');
        //    })
        //
            if ($name_es.val()=='') {
                $name_es.addClass('hightlight');
                return false;
            } else $name_es.removeClass('hightlight');

            if ($name_en.val()=='') {
                $name_en.addClass('hightlight');
                return false;
            } else $name_en.removeClass('hightlight');

            if ($description_es.val()=='') {
                $description_es.addClass('hightlight');
                return false;
            } else $description_es.removeClass('hightlight');

            if ($description_en.val()=='') {
                $description_en.addClass('hightlight');
                return false;
            } else $description_en.removeClass('hightlight');

            // TODO: genres hightlight

            if ($network.val()=='') {
                $network.addClass('hightlight');
                return false;
            } else $network.removeClass('hightlight');

            if ($runtime.val()=='') {
                $runtime.addClass('hightlight');
                return false;
            } else $runtime.removeClass('hightlight');

            // TODO: comprobamos que la duracion sea un numero

            // enviamos la peticion
            $.post(post_url, {
                'name_es': $name_es.val(),
                'name_en': $name_en.val(),
                'name': $name_es.val(),
                'description_es': $description_es.val(),
                'description_en': $description_en.val(),
                'description': $description_es.val(),
                'genres_raw': genres,
                'network': $network.val(),
                'runtime': $runtime.val(),
                'finished': $finished.val(),
                'csrfmiddlewaretoken': getCookie('csrftoken')
            }, function(data) {
                    switch (data.result) {
                        case 'Created':
                            $.jGrowl("La serie se ha creado exitosamente, gracias por colaborar");
                            window.location.href = data.redirect;
                            break;
                        case 'Updated':
                            $.jGrowl("La serie se ha actualizado exitosamente, gracias por colaborar");
                            window.location.href = data.redirect;
                            break;
                        case 'Duplicated':
                            $.jGrowl("Ya se encuentra una serie con ese nombre");
                            break;
                        default:
                            $.jGrowl("Ha ocurrido un error durante el envio, reportalo a bugs@liberateca.net");
                    }
            }  
            );  
        });

        </script>
{% endblock %}
